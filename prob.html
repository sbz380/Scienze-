<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Probabile formazione — calcolo media prime 10 giornate</title>
<style>
  body{font-family:system-ui,Segoe UI,Roboto,Arial; background:#f6f9fc; color:#123; margin:0; padding:18px;}
  .wrap{max-width:1100px; margin:auto;}
  h1{color:#0b57a4; margin:0 0 8px;}
  .grid{display:grid; grid-template-columns: 420px 1fr; gap:16px; align-items:start;}
  textarea{width:100%; height:360px; font-family:monospace; padding:10px; border:1px solid #cfe1fb; border-radius:8px; background:#fff;}
  button{background:#0b57a4; color:#fff; padding:10px 12px; border:0; border-radius:8px; cursor:pointer;}
  button.secondary{background:#fff; color:#0b57a4; border:1px solid #cfe1fb;}
  .controls{display:flex; gap:8px; margin-top:8px; flex-wrap:wrap;}
  table{width:100%; border-collapse:collapse; background:#fff; margin-top:12px; border-radius:8px; overflow:hidden;}
  th,td{padding:6px 8px; border-bottom:1px solid #eef6ff; text-align:center; font-size:13px;}
  th{background:#eaf4ff; color:#0b57a4; position:sticky; top:0;}
  .small{font-size:12px; color:#556;}
  input[type="number"]{width:70px;}
  .summary{margin-top:12px; padding:12px; background:#fff; border-radius:8px; border:1px solid #e6f1fb;}
  .right{display:flex; gap:8px; align-items:center; justify-content:flex-end;}
  .note{margin-top:10px; font-size:13px; color:#445;}
  .csvbtn{background:#0b7a3f}
  @media(max-width:920px){ .grid{grid-template-columns:1fr;} textarea{height:260px;} }
</style>
</head>
<body>
  <div class="wrap">
    <h1>Calcola media prime 10 giornate & voto formazione</h1>
    <p class="small">Incolla qui sotto il tuo blocco di testo "grezzo" (o carica CSV). Il sistema estrarrà i nomi e i valori numerici e calcolerà le medie. Poi spunta i giocatori che vuoi schierare.</p>

    <div class="grid">
      <div>
        <label><strong>1) Incolla i dati grezzi (o CSV) qui</strong></label>
        <textarea id="raw" placeholder="Incolla qui i tuoi dati...">3
4
5
6
7
8
9
10
11



butez 
5
5
5
5
6
6,5
4,5
6
x



di greg
3
5,5
5
7
4
x
4,5
5
x



montipo

5,5
x
8,5
6
4
3
4,5
x



lucumi
5.5

5,5
6,5

5,5
6,5
6
x



gosens
6.5
5,5
6
5
9,5
4,5
6

p(i)



joao m

5
7 
-
p
p


p



voj
5.5
5
x
6
6,5
6
10

p



serni
F
F
F
F
F
F
F
F
F
F
F
F
kalulu
5.5
6
6,5
6
5,5
6
6,5
6,5
x



bremer
9.5

5,5
-
O
O
O
O
O



patric 
O
O
p
-
p
p
p

p



conceicao
O
10
x
6,5
5,5
6

6
x



zarraga
6
5
p
-
p
p


p



marin


6
6
6
x
6

x



ndour 


p
6
p
6
5,5
4,5
x



adopo
6
6
5,5
6
5,5
5
6
5,5
x



frattesi

6
6
6
6
6


p



kone
5.5
6,5
10
6,5
6,5
5,5
6,5
6,5
x



suslov
O
O
O
O
O
O
O
O
O



bonny
5.5
6
p
14,5
10
5,5
6,5
5,5
x



david
7.5
6
x
5
5
5
6

p



davis
6
5,5
10
6
6
9,5
5,5

p



douvikas
6
5,5
6,5
5,5
6,5
6
10





sanabria
5.5
5,5
5,5
5
p
6






yldiz
11
6
6
5,5
x
x


x




6,2
5,8
6,4</textarea>

        <div class="controls">
          <button id="parseBtn">2) Analizza e crea tabella</button>
          <button id="clearBtn" class="secondary">Svuota dati</button>
          <input type="file" id="csvfile" accept=".csv" />
        </div>

        <div class="note">
          <strong>Nota:</strong> il parser cerca numeri anche con virgola (es. 6,5). Simboli come <em>x</em>, <em>p</em>, <em>O</em>, <em>-</em>, <em>F</em> vengono ignorati come assenze.
        </div>
      </div>

      <div>
        <div id="tableWrap" style="min-height:420px;">
          <!-- Table sarà qui -->
        </div>

        <div class="summary" id="summary" style="display:none;">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <strong>Totale formazione:</strong> <span id="totalSum">0</span>
              &nbsp; — &nbsp;
              <strong>Media formazione:</strong> <span id="avgSum">0</span>
            </div>
            <div class="right">
              <button id="exportCSV" class="csvbtn">Esporta CSV</button>
              <button id="resetSel" class="secondary">Deseleziona tutti</button>
            </div>
          </div>
          <div class="note">Puoi modificare i voti nella colonna <em>Voto schierato</em> per simulare variazioni.</div>
        </div>
      </div>
    </div>

    <p class="small" style="margin-top:12px">Se preferisci posso trasformarlo in un foglio Excel: basta dirmelo.</p>
  </div>

<script>
/*
 Parser strategy:
 - Take raw text, split into lines
 - Sweep lines: when a line contains letters and no numeric, treat as a name start
 - Collect up to 10 numeric tokens after the name (search forward)
 - Numeric tokens: accept digits, optional decimal comma or dot; parse and normalize to number
 - Non-numeric tokens ('x','p','O','-','F') ignored (treated as NaN)
 - Build array of players: {name, scores:[g1..g10], avg}
*/

function parseNumberToken(tok){
  if(!tok) return NaN;
  // normalize comma to dot, remove spaces
  tok = tok.replace(/\u00A0/g,'').replace(/,/g,'.').trim();
  // remove non-digit trailing chars
  if(/^[-+]?(\d+(\.\d+)?|\.\d+)$/.test(tok)) return parseFloat(tok);
  // sometimes token like "6 " (non-breaking), try numeric parse:
  let n = Number(tok);
  if(!isNaN(n)) return n;
  return NaN;
}

function parseRawText(raw){
  const lines = raw.split(/\r?\n/).map(l=>l.trim()).filter(l=>l.length>0);
  const players = [];
  let i = 0;
  while(i < lines.length){
    let line = lines[i];

    // If line looks like a player name: contains letters or spaces and not mainly numeric
    // Heuristic: contains at least one letter and not a leading numeric-only token
    if(/[A-Za-z\u00C0-\u017F]/.test(line) && !/^\d+(\.\d+|,\d+)?$/.test(line)){
      // assemble name: sometimes name on one line, sometimes with trailing spaces
      let name = line;
      // If next lines are also non-numeric short words, might be part of name (rare) - keep simple
      // Now collect up to 20 following tokens and extract numeric tokens
      let nums = [];
      let j = i+1;
      while(j < lines.length && nums.length < 10){
        // tokens may be multiple per line separated by spaces
        const toks = lines[j].split(/\s+/);
        for(const t of toks){
          const val = parseNumberToken(t);
          if(!isNaN(val)) {
            nums.push(val);
            if(nums.length >= 10) break;
          } else {
            // if token is clearly numeric-like but invalid, ignore
          }
        }
        // stop if we encounter another probable name line (contains letters and not numeric)
        if(/[A-Za-z\u00C0-\u017F]/.test(lines[j]) && !/^\d+(\.\d+|,\d+)?$/.test(lines[j])){
          // probably next player; break collecting
          break;
        }
        j++;
      }

      players.push({name: name, scores: nums});
      // advance i to j (or i+1 to avoid infinite)
      i = Math.max(j, i+1);
    } else {
      // line not a name: maybe numeric-only block before names; skip
      i++;
    }
  }
  return players;
}

function computeAverage(scores){
  if(!scores || scores.length===0) return NaN;
  const nums = scores.filter(v => typeof v === 'number' && !isNaN(v));
  if(nums.length===0) return NaN;
  const s = nums.reduce((a,b)=>a+b,0);
  return s / nums.length;
}

function buildTable(players){
  const wrap = document.getElementById('tableWrap');
  wrap.innerHTML = '';
  if(players.length===0){
    wrap.innerHTML = '<div class="note">Nessun giocatore estratto. Controlla il testo incollato.</div>';
    document.getElementById('summary').style.display = 'none';
    return;
  }

  // Build table dynamically
  const table = document.createElement('table');
  const thead = document.createElement('thead');
  const trh = document.createElement('tr');
  const headers = ['#','Giocatore','G1','G2','G3','G4','G5','G6','G7','G8','G9','G10','Media (prime 10)','Schiera','Voto schierato'];
  headers.forEach(h=>{
    const th = document.createElement('th');
    th.textContent = h;
    trh.appendChild(th);
  });
  thead.appendChild(trh);
  table.appendChild(thead);
  const tbody = document.createElement('tbody');

  players.forEach((p,idx)=>{
    const tr = document.createElement('tr');
    const tdIndex = document.createElement('td'); tdIndex.textContent = idx+1; tr.appendChild(tdIndex);

    const tdName = document.createElement('td'); tdName.textContent = p.name; tdName.style.textAlign='left'; tr.appendChild(tdName);

    // up to 10 scores
    for(let k=0;k<10;k++){
      const td = document.createElement('td');
      const v = p.scores[k];
      td.textContent = (typeof v === 'number' && !isNaN(v)) ? (Math.round(v*100)/100) : '';
      tr.appendChild(td);
    }

    // average
    const avg = computeAverage(p.scores);
    const tdAvg = document.createElement('td'); tdAvg.textContent = isNaN(avg) ? '' : (Math.round(avg*100)/100); tr.appendChild(tdAvg);

    // schiera checkbox
    const tdChk = document.createElement('td');
    const chk = document.createElement('input'); chk.type='checkbox'; chk.dataset.idx = idx;
    chk.addEventListener('change', updateSummary);
    tdChk.appendChild(chk);
    tr.appendChild(tdChk);

    // voto schierato (editable) - defaults to avg
    const tdV = document.createElement('td');
    const input = document.createElement('input');
    input.type='number'; input.step='0.1'; input.min='0'; input.max='20';
    input.style.width='70px';
    input.dataset.idx = idx;
    input.value = isNaN(avg) ? '' : (Math.round(avg*10)/10);
    // when user edits, update summary
    input.addEventListener('input', updateSummary);
    tdV.appendChild(input);
    tr.appendChild(tdV);

    tbody.appendChild(tr);

    // attach to player object references for convenience
    p._rowElements = {chk, input, tr, tdAvg};
  });

  table.appendChild(tbody);
  wrap.appendChild(table);
  document.getElementById('summary').style.display = 'block';
  updateSummary();
}

function updateSummary(){
  const wrap = document.getElementById('tableWrap');
  const table = wrap.querySelector('table');
  if(!table){ document.getElementById('summary').style.display='none'; return; }
  const rows = Array.from(table.querySelectorAll('tbody tr'));
  let total = 0;
  let count = 0;
  rows.forEach(r=>{
    const chk = r.querySelector('input[type="checkbox"]');
    const numInput = r.querySelector('input[type="number"]');
    const val = parseFloat(numInput.value);
    if(chk && chk.checked){
      if(!isNaN(val)){
        total += val;
        count += 1;
      }
    }
  });
  document.getElementById('totalSum').textContent = (Math.round(total*100)/100) || 0;
  document.getElementById('avgSum').textContent = count? (Math.round((total/count)*100)/100) : 0;
}

document.getElementById('parseBtn').addEventListener('click', ()=>{
  const raw = document.getElementById('raw').value;
  const players = parseRawText(raw);
  // compute averages and ensure array length 10
  players.forEach(p=>{
    // ensure exactly 10 slots (fill with NaN where missing)
    const arr = p.scores.slice(0,10);
    while(arr.length<10) arr.push(NaN);
    p.scores = arr;
    p.avg = computeAverage(p.scores);
  });
  // build table
  buildTable(players);
  // store players on window for export, editing etc.
  window._players = players;
});

// Clear button
document.getElementById('clearBtn').addEventListener('click', ()=>{
  document.getElementById('raw').value = '';
  document.getElementById('tableWrap').innerHTML = '';
  document.getElementById('summary').style.display = 'none';
});

// CSV file loader (optional)
document.getElementById('csvfile').addEventListener('change', (ev)=>{
  const f = ev.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = function(e){
    document.getElementById('raw').value = e.target.result;
  };
  reader.readAsText(f);
});

// export CSV
document.getElementById('exportCSV').addEventListener('click', ()=>{
  const players = window._players || [];
  if(players.length===0) return alert('Nessun dato da esportare');
  // rebuild from table rows to include Voto schierato and Schiera
  const table = document.querySelector('#tableWrap table');
  const rows = Array.from(table.querySelectorAll('tbody tr'));
  let csv = ['Giocatore,G1,G2,G3,G4,G5,G6,G7,G8,G9,G10,Media,Schierato,Voto_schierato'].join(',') + '\n';
  rows.forEach(r=>{
    const name = r.cells[1].textContent.replace(/,/g,'');
    const scores = [];
    for(let i=2;i<12;i++){
      scores.push(r.cells[i].textContent || '');
    }
    const avg = r.cells[12].textContent || '';
    const sch = r.querySelector('input[type="checkbox"]').checked ? 'Sì' : 'No';
    const voto = r.querySelector('input[type="number"]').value || '';
    csv += [name, ...scores, avg, sch, voto].join(',') + '\n';
  });
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'formazione_export.csv'; a.click();
  URL.revokeObjectURL(url);
});

// reset selection
document.getElementById('resetSel').addEventListener('click', ()=>{
  const table = document.querySelector('#tableWrap table');
  if(!table) return;
  const checks = table.querySelectorAll('tbody input[type="checkbox"]');
  checks.forEach(c=>c.checked = false);
  updateSummary();
});

// init: pre-parse sample after small delay
setTimeout(()=>{ document.getElementById('parseBtn').click(); }, 100);
</script>
</body>
</html>